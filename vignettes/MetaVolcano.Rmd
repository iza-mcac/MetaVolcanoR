---
title: 'MetaVolcanoR: Differential expression meta-analysis tool'
date: Feb 1, 2026
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
  prettydoc::html_pretty:
    highlight: github
    theme: lumen
    toc: yes
vignette: > 
  %\VignetteIndexEntry{MetaVolcanoR: Differential expression meta-analysis tool}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r style, echo=FALSE, results="asis", message=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache=TRUE)
```

# Introduction: Why Meta-Analysis?

Imagine you're studying a disease and find 5 different studies on Gene Expression Omnibus, each identifying ~500 differentially expressed genes (DEGs). But only 50 genes overlap! 
Which genes are truly important?

**MetaVolcanoR solves this by:**
- Combining evidence across studies
- Identifying consistently perturbed genes
- Visualizing meta-analysis results intuitively

Comparing the expression of genes under a given condition against a reference 
biological state is usually applied to identify sets of differentially 
expressed genes (DEG). These DEG point out the genomic regions functionally 
relevant under the biological condition of interest. 

Athough individual genome-wide expression studies have small signal/noise ratio,
today's genomic data availability usually allows to combine differential gene 
expression results from dozens of independent studies to overcome this limitation. 

Databases such as GEO (https://www.ncbi.nlm.nih.gov/geo/), SRA 
(https://www.ncbi.nlm.nih.gov/sra), ArrayExpress, 
(https://www.ebi.ac.uk/arrayexpress/), and ENA (https://www.ebi.ac.uk/ena) offer
systematic access to vast amounts of transcriptome data. There exists more than
one gene expression study for many biological conditions. This redundancy could
be exploit by meta-analysis approaches to reveal genes that are consistently present
and differentially expressed under given conditions.

MetaVolcanoR was designed to identify the genes whose expression is consistently 
perturbed across several DE tables. 

# Usage

## Overview 
The MetaVolcanoR R package combines differential gene expression results. It 
implements three strategies to summarize gene expression activities from 
different studies. i) Random Effects Model (REM) approach. ii) a vote-counting
approach, and iii) a p-value combining-approach. MetaVolcano exploits the 
Volcano plot reasoning to visualize these meta-analysis of gene expression results.

## Installation

```{r}

```

## Load library

```{r}
library(MetaVolcanoR)
```

## Preparing Your Data

MetaVolcanoR requires differential expression results with:

1. **Gene identifiers** (gene names or IDs)
2. **Log2 fold changes**
3. **P-values**
4. **Confidence intervals OR variance** (for REM method only)

### If you have confidence intervals (CI)

If your DE results include confidence interval columns (example: `CI.L` and `CI.R`), you\'re ready to go! The package will automatically calculate variance:
```{r, eval=FALSE}
# Your data has CI.L and CI.R columns
meta_rem <- rem_mv(
  diffexp = your_data_list,
  llcol = "CI.L",      # Left limit of CI
  rlcol = "CI.R",      # Right limit of CI
  cvar = TRUE          # Calculate variance from CI (default)
)
```

### If you have standard error (SE)

Most tools (DESeq2, limma, edgeR) output **standard error**, not confidence intervals. Convert SE to 95% CI:
```{r, eval=FALSE}
# From DESeq2 results
deseq_results <- results(dds) #or after shrinkage
deseq_results$CI.L <- deseq_results$log2FoldChange - 1.96 * deseq_results$lfcSE
deseq_results$CI.R <- deseq_results$log2FoldChange + 1.96 * deseq_results$lfcSE

# From limma results (if you have SE column)
limma_results$CI.L <- limma_results$logFC - 1.96 * limma_results$SE
limma_results$CI.R <- limma_results$logFC + 1.96 * limma_results$SE
```

### If you have variance directly

If you have variance (or can calculate it from SE: `variance = SE^2`), use the `vcol` parameter:
```{r, eval=FALSE}
# Calculate variance from standard error
your_data$variance <- your_data$SE^2

# Use variance directly
meta_rem <- rem_mv(
  diffexp = your_data_list,
  vcol = "variance",   # Column name with variance
  cvar = FALSE         # Don\'t calculate from CI
)
```

### Preparing reuslts from common DE tools

MetaVolcanoR provides convenient helper functions to prepare results from common DE tools:
```{r, eval=FALSE}
# For DESeq2 results 
deg_table <- prepare_deseq2(res)

# For limma results
deg_table <- prepare_limma(limma_toptable)

# For edgeR results
deg_table <- prepare_edger(edger_toptags$table)
```

**Complete workflow with helper functions:**
```{r, eval=FALSE}
library(DESeq2)
library(MetaVolcanoR)

# Run your DESeq2 analysis
dds <- DESeqDataSetFromMatrix(count_matrix, sample_info, design = ~ condition)
dds <- DESeq(dds)

# Get results for multiple comparisons
res_treatment1 <- results(dds, contrast = c("condition", "Treatment1", "Control"))
res_treatment2 <- results(dds, contrast = c("condition", "Treatment2", "Control"))
res_treatment3 <- results(dds, contrast = c("condition", "Treatment3", "Control"))

# Prepare all studies using helper function
study1 <- prepare_deseq2(res_treatment1)
study2 <- prepare_deseq2(res_treatment2)
study3 <- prepare_deseq2(res_treatment3)

# Combine into named list
my_studies <- list(
  "Treatment1_vs_Control" = study1,
  "Treatment2_vs_Control" = study2,
  "Treatment3_vs_Control" = study3
)

# Run meta-analysis
meta_results <- rem_mv(
  diffexp = my_studies,
  metathr = 0.01,
  outputfolder = tempdir(),
  draw = "HTML"
)

# View results
meta_results@MetaVolcano
head(meta_results@metaresult)
```

**Testing the helper functions:**

You can test if your data is correctly formatted:
```{r}
# Load example data
data(diffexplist)

# Check the required columns
head(diffexplist[[1]])

# Your prepared data should have these columns:
# - Symbol (or gene identifier)
# - Log2FC (fold change)
# - pvalue (p-value)
# - CI.L (lower confidence interval, for REM only)
# - CI.R (upper confidence interval, for REM only)

# Test with one study
str(diffexplist[[1]])
```

**Note:** The `prepare_*` functions automatically:
- Remove rows with NA values
- Calculate 95% confidence intervals from standard errors
- Format column names to match MetaVolcanoR requirements
- Filter out infinite values

# Implemented meta-analysis approaches

## Random Effect Model MetaVolcano

The *REM* MetaVolcano summarizes the gene fold change of several studies taking
into account the variance. The *REM* estimates a *summary p-value* which stands 
for the probability of the *summary fold-change* is not different than zero. 
Users can set the *metathr* parameter to highlight the top percentage of the 
most consistently perturbed genes. This perturbation ranking is defined 
following the *topconfects* approach.


```{r}
meta_degs_rem <- rem_mv(diffexp=diffexplist,
			pcriteria="pvalue",
			foldchangecol='Log2FC', 
			genenamecol='Symbol',
			geneidcol=NULL,
			collaps=FALSE,
			llcol='CI.L',
			rlcol='CI.R',
			vcol=NULL, 
			cvar=TRUE,
			metathr=0.01,
			jobname="MetaVolcano",
			outputfolder=".", 
			draw='HTML',
			ncores=1)

head(meta_degs_rem@metaresult, 3)

meta_degs_rem@MetaVolcano

draw_forest(remres=meta_degs_rem,
	    gene="MMP9",
	    genecol="Symbol", 
	    foldchangecol="Log2FC",
	    llcol="CI.L", 
	    rlcol="CI.R",
	    jobname="MetaVolcano",
	    outputfolder=".",
	    draw="HTML")

draw_forest(remres=meta_degs_rem,
	    gene="COL6A6",
	    genecol="Symbol", 
	    foldchangecol="Log2FC",
	    llcol="CI.L", 
	    rlcol="CI.R",
	    jobname="MetaVolcano",
	    outputfolder=".",
	    draw="HTML")

```

&nbsp;
The *REM* MetaVolcano also allows users to explore the forest plot of a given 
gene based on the REM results.

## Vote-counting approach

The *vote-counting* MetaVolcano identifies differential expressed genes (DEG) 
for each study based on the user-defined *p-value* and *fold change* thresholds.
It displays the number of differentially expressed and unperturbed genes per 
study. In addition, it plots the inverse cumulative distribution of the 
consistently DEG, so the user can identify the number of genes whose expression
is perturbed in at least 1 or n studies.

```{r}
meta_degs_vote <- votecount_mv(diffexp=diffexplist,
			       pcriteria='pvalue',
			       foldchangecol='Log2FC',
			       genenamecol='Symbol',
			       geneidcol=NULL,
			       pvalue=0.05,
			       foldchange=0, 
			       metathr=0.01,
			       collaps=FALSE,
			       jobname="MetaVolcano", 
			       outputfolder=".",
			       draw='HTML')

head(meta_degs_vote@metaresult, 3)
meta_degs_vote@degfreq
```

The *vote-counting* MetaVolcano visualizes genes based on the number of studies
where genes were identified as differentially expressed and the gene fold change 
sign consistency. It means that a gene that was differentially expressed in five 
studies, from which three of them it was downregulated, will get a sign 
consistency score of 2 + (-3) = -1. Based on user preference, MetaVolcano can 
highlight the top *metathr* percentage of consistently perturbed genes.


```{r}
meta_degs_vote@MetaVolcano
```

## Combining-approach 

The *combinig* MetaVolcano summarizes the fold change of a gene in different 
studies by the *mean* or *median* depending on the user preference. In addition,
the *combinig* MetaVolcano summarizes the gene differential expression 
*p-values* using the Fisher method. The *combining* MetaVolcano can highlight 
the top *metathr* percentage of consistently perturbed genes.


```{r}
meta_degs_comb <- combining_mv(diffexp=diffexplist,
			       pcriteria='pvalue', 
			       foldchangecol='Log2FC',
			       genenamecol='Symbol',
			       geneidcol=NULL,
			       metafc='Mean',
			       metathr=0.01, 
			       collaps=TRUE,
			       jobname="MetaVolcano",
			       outputfolder=".",
			       draw='HTML')

head(meta_degs_comb@metaresult, 3)
meta_degs_comb@MetaVolcano
```


# Customizing Your Plots

MetaVolcanoR provides extensive customization options to create publication-ready figures and highlight specific genes of interest.

## Basic Customization Options

All main functions (`rem_mv`, `votecount_mv`, `combining_mv`) support these parameters:

- **colors**: Custom color schemes
- **point_size**: Size of data points
- **label_genes**: Vector of specific genes to label
- **label_top_n**: Automatically label top N genes
- **label_size**: Size of gene labels
- **plot_title**: Custom plot title
- **show_legend**: Show or hide legend

## Example 1: Custom Colors and Gene Labels
```{r, eval=FALSE}
# REM with custom colors and specific genes labeled
meta_custom <- rem_mv(
  diffexp = diffexplist,
  metathr = 0.01,
  outputfolder = tempdir(),
  draw = "HTML",
  # Customization parameters:
  colors = c(low = "navy", mid = "white", high = "darkred", na = "gray80"),
  point_size = 1.5,
  label_genes = c("MMP9", "COL6A6", "MXRA5", "CIDEA"),
  label_size = 4,
  plot_title = "REM Meta-Analysis - Custom Colors",
  show_legend = TRUE
)

meta_custom@MetaVolcano
```

## Example 2: Highlighting Top Genes Automatically
```{r, eval=FALSE}
# Vote-counting with automatic labeling of top 10 genes
meta_vote_labeled <- votecount_mv(
  diffexp = diffexplist,
  pvalue = 0.05,
  metathr = 0.01,
  outputfolder = tempdir(),
  draw = "HTML",
  # Automatically label top 10 most significant genes
  colors = c("steelblue", "gray90", "firebrick"),
  point_size = 1.2,
  label_top_n = 10,
  label_size = 3.5,
  plot_title = "Vote-Counting: Top 10 DEGs Labeled"
)

meta_vote_labeled@MetaVolcano
```

## Example 3: Publication-Ready Figures
```{r, eval=FALSE}
# Combining approach with publication styling
meta_publication <- combining_mv(
  diffexp = diffexplist,
  metafc = "Median",
  metathr = 0.01,
  collaps = TRUE,
  outputfolder = tempdir(),
  draw = "HTML",
  # Publication-ready styling
  colors = c("darkgreen", "white", "darkorange"),
  point_size = 1.0,
  label_genes = c("MMP9", "ANG", "ACVR1C"),
  label_size = 3,
  plot_title = NULL,  # No title for publication
  show_legend = FALSE
)

meta_publication@MetaVolcano
```

## Example 4: Customizing Forest Plots

Forest plots also support extensive customization:
```{r, eval=FALSE}
# Custom forest plot with specific colors and dimensions
draw_forest(
  remres = meta_degs_rem,
  gene = "MMP9",
  outputfolder = tempdir(),
  draw = "PDF",
  # Customization:
  colors = c(
    positive = "darkred",    # Color for positive fold changes
    negative = "steelblue",  # Color for negative fold changes
    neutral = "gray70",      # Color for individual studies
    reference = "black"      # Color for reference lines
  ),
  point_size = 3,
  plot_width = 7,          # Width in inches (for PDF)
  plot_height = 6,         # Height in inches
  plot_title = "MMP9 Expression Meta-Analysis"
)
```

## Color Scheme Examples

### Color Schemes for Different Contexts
```{r, eval=FALSE}
# Professional/Conservative
colors_professional <- c(low = "blue", mid = "white", high = "red", na = "gray80")

# High Contrast (for presentations)
colors_presentation <- c(low = "purple", mid = "white", high = "orange", na = "lightgray")

# Color-blind friendly
colors_colorblind <- c(low = "#0072B2", mid = "white", high = "#D55E00", na = "gray80")

# Grayscale (for print)
colors_grayscale <- c(low = "black", mid = "gray90", high = "gray30", na = "gray70")

# Use any of these:
meta_rem <- rem_mv(
  diffexp = diffexplist,
  colors = colors_colorblind,  # Or any other scheme
  # ... other parameters
)
```

### Vote-counting and Combining Colors

For vote-counting and combining approaches, provide a vector of 3 colors:
```{r, eval=FALSE}
# Custom colors: [downregulated, neutral, upregulated]
custom_colors <- c("navyblue", "gray85", "darkred")

meta_vote <- votecount_mv(
  diffexp = diffexplist,
  colors = custom_colors,
  # ... other parameters
)
```

## Combining Multiple Customizations
```{r, eval=FALSE}
# Complete customization example
meta_final <- rem_mv(
  diffexp = diffexplist,
  metathr = 0.01,
  outputfolder = tempdir(),
  draw = "HTML",
  ncores = 4,
  # All customization options
  colors = c(low = "#0072B2", mid = "white", high = "#D55E00", na = "gray80"),
  point_size = 1.5,
  label_genes = c("MMP9", "COL6A6"),  # Label specific genes
  label_top_n = 5,                    # Also label top 5
  label_size = 3.5,
  plot_title = "Meta-Analysis: Disease vs Control",
  show_legend = TRUE
)

# Access the customized plot
meta_final@MetaVolcano

# View the forest plot for a specific gene
draw_forest(
  remres = meta_final,
  gene = "MMP9",
  outputfolder = tempdir(),
  draw = "PDF",
  colors = c(positive = "#D55E00", negative = "#0072B2", 
            neutral = "gray60", reference = "black"),
  point_size = 3,
  plot_width = 8,
  plot_height = 6
)
```

## Tips for Publication-Quality Figures

1. **Use color-blind friendly palettes** (see examples above)
2. **Set `show_legend = FALSE`** for cleaner figures (add legend in figure caption)
3. **Label only key genes** instead of showing all labels
4. **Use `plot_title = NULL`** and add titles in your manuscript
5. **Save as PDF** (`draw = "PDF"`) for vector graphics in publications
6. **Adjust `plot_width` and `plot_height`** to match journal requirements
7. **Use consistent colors** across all figures in your paper

## Saving Plots Separately

If you want to save plots with specific dimensions without displaying them:
```{r, eval=FALSE}
# Generate the meta-analysis
meta_result <- rem_mv(
  diffexp = diffexplist,
  draw = "HTML",  # or "PDF"
  outputfolder = "path/to/output",
  # ... other parameters
)

# The plot is automatically saved to the outputfolder
# For HTML: interactive plot you can explore in browser
# For PDF: publication-ready vector graphics
```
